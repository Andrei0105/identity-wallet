<!DOCTYPE html>
<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://unpkg.com/blockstack@19.2.1/dist/blockstack.js"
        integrity="sha384-+qYCYoUGzsMLAzHm80c4DyhbWgHBBb2N0RFqsg7Lws5ljtBtj/IwpgxZkiR7j7lp"
        crossorigin="anonymous"></script>
    <script>
        var url = new URL(window.location.href);
        var ar = url.searchParams.get("authResponse");

        if (ar) {
            console.log(ar);
        }
        window.parent.postMessage({ auth_response: ar }, '*');

    </script>
</head>

<body>
    <input name="name" type="text" id="name">
    <input name="country" type="text" id="country">

    <button type="button" id='static_login_btn'>Login with IW</button>
    <button type="button" id='static_login_btn_blockstack'>Login with Blockstack</button>
    <button type="button" id='signin-button'>Inpage blockstack test</button>
    <button type="button" id='aries-connect-button'>Aries connect</button>
    <select id="sel_cred">
        <option value="person_schema_credential">person_schema_credential</option>
        <option value="age_schema_credential">age_schema_credential</option>
        <option value="name_schema_credential">name_schema_credential</option>
    </select>
    <button type="button" id='aries-credential-button'>Get Aries credential</button>
    <select id="sel_proof">
        <option value="person_schema_presentation">person_schema_presentation</option>
        <option value="non_restricted_presentation">non_restricted_presentation</option>
    </select>
    <button type="button" id='aries-proof-button'>Present Aries proof</button>
    <script>
        function getInvitation() {
            // generate a connection invitation on the page's agent
            // this should be managed by the page
            var jqXHR = $.ajax({
                type: 'POST',
                url: 'http://localhost:5050/connections/create-invitation',
                async: false
            });
            window.requestedConnectionId = jqXHR.responseJSON.connection_id.toString();
            return JSON.stringify(jqXHR.responseJSON.invitation);
        }

        person_schema_credential = '{\
  "credential_values": {"name": "Alice Smith", "age": "24"},\
  "credential_definition_id": "UPwPYH1pNP33UCpHDe8Cg9:3:CL:13:default",\
  "connection_id": "3cdb9712-5fb8-48ba-8ac0-48c721859133"\
}';

        age_schema_credential = '{\
  "credential_values": {"age": "24"},\
  "credential_definition_id": "UPwPYH1pNP33UCpHDe8Cg9:3:CL:15:default",\
  "connection_id": "3cdb9712-5fb8-48ba-8ac0-48c721859133"\
}';
        name_schema_credential = '{\
  "credential_values": {"name": "Alice"},\
  "credential_definition_id": "UPwPYH1pNP33UCpHDe8Cg9:3:CL:17:default",\
  "connection_id": "3cdb9712-5fb8-48ba-8ac0-48c721859133"\
}';

        function startCredentialExchangeAndGetUpdatedAt() {
            // creating the public DID, the Schema and the Credential def
            // should be managed by the page's agent;
            // on user interaction to request a credential, the page's agent
            // should use /credential-exchage/send to start a cred exchange;
            // the credential exchange id must be sent to the page
            data = eval(document.getElementById('sel_cred').value)
            var jqXHR = $.ajax({
                type: 'POST',
                url: 'http://localhost:5050/credential_exchange/send',
                // hardcoded test credential exchange
                data: data,
                async: false
            });
            console.log('Generated credential exchange:', jqXHR.responseJSON)
            return jqXHR.responseJSON.created_at;
        }

        person_schema_presentation = '{\
  "requested_predicates": [\
    {\
      "name": "age",\
      "p_type": ">=",\
      "restrictions": [\
        {"cred_def_id" : "UPwPYH1pNP33UCpHDe8Cg9:3:CL:13:default"}\
      ],\
      "p_value":  18\
    }\
  ],\
  "requested_attributes": [\
    {\
      "name": "name",\
      "restrictions": [\
        {"cred_def_id" : "UPwPYH1pNP33UCpHDe8Cg9:3:CL:13:default"}\
      ]\
    }\
  ],\
  "name": "Proof of Age",\
  "version": "1.0",\
  "connection_id": "3cdb9712-5fb8-48ba-8ac0-48c721859133"\
}';

        non_restricted_presentation = '{\
  "requested_predicates": [\
    {\
      "name": "age",\
      "p_type": ">=",\
      "restrictions": [\
      ],\
      "p_value":  18\
    }\
  ],\
  "requested_attributes": [\
    {\
      "name": "name",\
      "restrictions": [\
      ]\
    }\
  ],\
  "name": "Proof of Age",\
  "version": "1.0",\
  "connection_id": "3cdb9712-5fb8-48ba-8ac0-48c721859133"\
}';

        function startProofExchangeAndGetUpdatedAt() {
            data = eval(document.getElementById('sel_proof').value)
            var jqXHR = $.ajax({
                type: 'POST',
                url: 'http://localhost:5050/presentation_exchange/send_request',
                // hardcoded example proof request
                data: data,
                async: false
            });
            window.generatedPresentationRequestId = jqXHR.responseJSON.presentation_exchange_id
            console.log('Generated proof request:', jqXHR.responseJSON)
            return Date.now().toString();
        }

        function initiateAriesConnectionWrapper() {
            invitation = getInvitation();
            console.log(invitation);
            iw.initiateAriesConnection({ data: { invitation: invitation } });
        }

        function notifyCredentialRequestWrapper() {
            credential_created_at = startCredentialExchangeAndGetUpdatedAt();
            iw.notifyCredentialRequest({ data: { credential_created_at: credential_created_at } });
        }

        function notifyProofRequestWrapper() {
            proof_request_created_at = startProofExchangeAndGetUpdatedAt();
            iw.notifyProofRequest({ data: { proof_request_created_at: proof_request_created_at } });
        }

        function useIW() {
            if (typeof iw !== 'undefined') {
                $(document).ready(function () {
                    $('#static_login_btn').click({ simple: ['name', 'country'], verified: ['Example', 'Diploma'] },
                        iw.requestUportClaims);
                    $('#static_login_btn_blockstack').click({ simple: ['name', 'country'], verified: ['Example', 'Diploma'] },
                        iw.requestBlockstackClaims);
                    $('#aries-connect-button').click(initiateAriesConnectionWrapper);
                    $('#aries-credential-button').click(notifyCredentialRequestWrapper);
                    $('#aries-proof-button').click(notifyProofRequestWrapper);
                    setTimeout(userResponseAction, 500);
                });
            }
            else {
                setTimeout(useIW, 50);
            }
        }
        setTimeout(useIW, 50);

        function userResponseAction() {
            // Everything happening in this function should be managed by the page
            // without any interaction with the extension
            if (typeof iw.requestedClaims !== 'undefined') {
                // Check uPort received claims
                console.log('PAGE:', 'Received claims:', iw.requestedClaims);
                iw.requestedClaims = undefined;
            }
            if (typeof iw.ariesConnectionAccepted !== 'undefined') {
                if (iw.ariesConnectionAccepted) {
                    // Check Aries user response
                    // This is an example. The request should be issued from the page's backend
                    console.log('PAGE:', 'Aries connection accepted?', iw.ariesConnectionAccepted)
                    state = ''
                    function getState() {
                        $.get('http://localhost:5050/connections/' + window.requestedConnectionId,
                            function (data, status, jqXHR) {
                                state = data.state;
                                console.log('PAGE:', 'Checking connection state: ', state);
                                if (state !== 'request')
                                    setTimeout(getState, 1000);
                                else {
                                    $.post('http://localhost:5050/connections/' + window.requestedConnectionId + '/accept-request',
                                        function (data, status, jqXHR) {
                                            // At this point, the response should have state 'response'
                                            // The connection is active, the page can check by issuing a GET /connections
                                            console.log('PAGE:', 'Page agent issuing accept-request. Response: ', data);
                                        });
                                }
                            });
                    }
                    setTimeout(getState, 1000);
                }
                else if (iw.ariesConnectionAccepted === false) {
                    console.log('PAGE:', 'User rejected the Aries connection.');
                }
                iw.ariesConnectionAccepted = undefined;
            }
            if (typeof iw.ariesCredentialAccepted !== 'undefined') {
                if (iw.ariesCredentialAccepted) {
                    // Check Aries credential issue response
                    // This is not required. The page's agent can do nothing more now
                    // The page can ignore the value if it doesn't require to check
                    // if the user accepted the credential
                    // If the user rejected it, the page can check the value and
                    // then promp the user again
                    console.log('PAGE:', 'Aries credential accepted?', iw.ariesCredentialAccepted)
                }
                else if (iw.ariesCredentialAccepted === false) {
                    console.log('PAGE:', 'User rejected the Aries credential.');
                }
                iw.ariesCredentialAccepted = undefined;
            }
            if (typeof iw.ariesProofRequestAccepted !== 'undefined') {
                if (iw.ariesProofRequestAccepted) {
                    console.log('PAGE:', 'Aries proof request accepted?', iw.ariesProofRequestAccepted)
                    function getState() {
                        $.get('http://localhost:5050/presentation_exchange/' + window.generatedPresentationRequestId,
                            function (data, status, jqXHR) {
                                state = data.state;
                                console.log('PAGE:', 'Checking proof request state: ', state);
                                console.log('PAGE:', 'Proof request: ', data);
                                if (state !== 'verified')
                                    setTimeout(getState, 1000);
                            });
                    }
                    setTimeout(getState, 1000);
                }
                else if (iw.ariesProofRequestAccepted === false) {
                    console.log('PAGE:', 'User rejected the Aries presentation request.');
                }
                iw.ariesProofRequestAccepted = undefined;
            }
            setTimeout(userResponseAction, 500);
        }

        function useBlockstack() {
            if (typeof window.blockstack !== "undefined") {
                authReq = blockstack.makeAuthRequest();
                document.getElementById('signin-button').addEventListener('click', function () {
                    console.log('here')
                    blockstack.redirectToSignInWithAuthRequest(authReq);
                });

            }
        }

        setTimeout(useBlockstack, 1000);
    </script>

</body>

</html>