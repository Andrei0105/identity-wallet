# Testing Aries Agents
This is a guide for setting up 2 Aries Cloud Agents connected to a local Hyperledger Indy Pool to use as test environment. Connecting the 2 agents, creating DIDs, schemas and credential definitions, issuing credentials and presenting proofs is also demonstrated.\
Requirements: libindy, indy-cli, aca-py.
## Starting the Indy Local Pool
Clone the indy-sdk repo: https://github.com/hyperledger/indy-sdk \
Run the following command to create a 4 node cluster:
```
docker build -f ci/indy-pool.dockerfile -t indy_pool .
```
Start the container:
```
docker run -itd -p 9701-9708:9701-9708 indy_pool
```
Save the following genesis file (eg: genesis-pool-config):
```
{"reqSignature":{},"txn":{"data":{"data":{"alias":"Node1","blskey":"4N8aUNHSgjQVgkpm8nhNEfDf6txHznoYREg9kirmJrkivgL4oSEimFF6nsQ6M41QvhM2Z33nves5vfSn9n1UwNFJBYtWVnHYMATn76vLuL3zU88KyeAYcHfsih3He6UHcXDxcaecHVz6jhCYz1P2UZn2bDVruL5wXpehgBfBaLKm3Ba","blskey_pop":"RahHYiCvoNCtPTrVtP7nMC5eTYrsUA8WjXbdhNc8debh1agE9bGiJxWBXYNFbnJXoXhWFMvyqhqhRoq737YQemH5ik9oL7R4NTTCz2LEZhkgLJzB3QRQqJyBNyv7acbdHrAT8nQ9UkLbaVL9NBpnWXBTw4LEMePaSHEw66RzPNdAX1","client_ip":"127.0.0.1","client_port":9702,"node_ip":"127.0.0.1","node_port":9701,"services":["VALIDATOR"]},"dest":"Gw6pDLhcBcoQesN72qfotTgFa7cbuqZpkX3Xo6pLhPhv"},"metadata":{"from":"Th7MpTaRZVRYnPiabds81Y"},"type":"0"},"txnMetadata":{"seqNo":1,"txnId":"fea82e10e894419fe2bea7d96296a6d46f50f93f9eeda954ec461b2ed2950b62"},"ver":"1"}
{"reqSignature":{},"txn":{"data":{"data":{"alias":"Node2","blskey":"37rAPpXVoxzKhz7d9gkUe52XuXryuLXoM6P6LbWDB7LSbG62Lsb33sfG7zqS8TK1MXwuCHj1FKNzVpsnafmqLG1vXN88rt38mNFs9TENzm4QHdBzsvCuoBnPH7rpYYDo9DZNJePaDvRvqJKByCabubJz3XXKbEeshzpz4Ma5QYpJqjk","blskey_pop":"Qr658mWZ2YC8JXGXwMDQTzuZCWF7NK9EwxphGmcBvCh6ybUuLxbG65nsX4JvD4SPNtkJ2w9ug1yLTj6fgmuDg41TgECXjLCij3RMsV8CwewBVgVN67wsA45DFWvqvLtu4rjNnE9JbdFTc1Z4WCPA3Xan44K1HoHAq9EVeaRYs8zoF5","client_ip":"127.0.0.1","client_port":9704,"node_ip":"127.0.0.1","node_port":9703,"services":["VALIDATOR"]},"dest":"8ECVSk179mjsjKRLWiQtssMLgp6EPhWXtaYyStWPSGAb"},"metadata":{"from":"EbP4aYNeTHL6q385GuVpRV"},"type":"0"},"txnMetadata":{"seqNo":2,"txnId":"1ac8aece2a18ced660fef8694b61aac3af08ba875ce3026a160acbc3a3af35fc"},"ver":"1"}
{"reqSignature":{},"txn":{"data":{"data":{"alias":"Node3","blskey":"3WFpdbg7C5cnLYZwFZevJqhubkFALBfCBBok15GdrKMUhUjGsk3jV6QKj6MZgEubF7oqCafxNdkm7eswgA4sdKTRc82tLGzZBd6vNqU8dupzup6uYUf32KTHTPQbuUM8Yk4QFXjEf2Usu2TJcNkdgpyeUSX42u5LqdDDpNSWUK5deC5","blskey_pop":"QwDeb2CkNSx6r8QC8vGQK3GRv7Yndn84TGNijX8YXHPiagXajyfTjoR87rXUu4G4QLk2cF8NNyqWiYMus1623dELWwx57rLCFqGh7N4ZRbGDRP4fnVcaKg1BcUxQ866Ven4gw8y4N56S5HzxXNBZtLYmhGHvDtk6PFkFwCvxYrNYjh","client_ip":"127.0.0.1","client_port":9706,"node_ip":"127.0.0.1","node_port":9705,"services":["VALIDATOR"]},"dest":"DKVxG2fXXTU8yT5N7hGEbXB3dfdAnYv1JczDUHpmDxya"},"metadata":{"from":"4cU41vWW82ArfxJxHkzXPG"},"type":"0"},"txnMetadata":{"seqNo":3,"txnId":"7e9f355dffa78ed24668f0e0e369fd8c224076571c51e2ea8be5f26479edebe4"},"ver":"1"}
{"reqSignature":{},"txn":{"data":{"data":{"alias":"Node4","blskey":"2zN3bHM1m4rLz54MJHYSwvqzPchYp8jkHswveCLAEJVcX6Mm1wHQD1SkPYMzUDTZvWvhuE6VNAkK3KxVeEmsanSmvjVkReDeBEMxeDaayjcZjFGPydyey1qxBHmTvAnBKoPydvuTAqx5f7YNNRAdeLmUi99gERUU7TD8KfAa6MpQ9bw","blskey_pop":"RPLagxaR5xdimFzwmzYnz4ZhWtYQEj8iR5ZU53T2gitPCyCHQneUn2Huc4oeLd2B2HzkGnjAff4hWTJT6C7qHYB1Mv2wU5iHHGFWkhnTX9WsEAbunJCV2qcaXScKj4tTfvdDKfLiVuU2av6hbsMztirRze7LvYBkRHV3tGwyCptsrP","client_ip":"127.0.0.1","client_port":9708,"node_ip":"127.0.0.1","node_port":9707,"services":["VALIDATOR"]},"dest":"4PS3EDQ3dW1tci1Bp6543CfuuebjFrg36kLAUcskGfaA"},"metadata":{"from":"TWwCRQRZ2ZHMJFn9TzLp7W"},"type":"0"},"txnMetadata":{"seqNo":4,"txnId":"aa5e817d7cc626170eca175822029339a444eb0ee8f0bd20d3b0b76e566fb008"},"ver":"1"}
```
Open up the Indy cli by running ```indy-cli``` in a terminal window.\
Use the indy-cli to create a local-pool:
```
pool create indy_pool gen_txn_file=/path/to/genesis/file
```
If, needed the pool can be managed from the CLI by connecting to it using:
```
pool connect indy-pool
```
## Starting the Indy Ledger Browser
The Ledger Browser enables registering DIDs on the ledger and keeping track of transactions.\
Clone the von-network repo: https://github.com/bcgov/von-network \
Run in the root von directory:
```
sudo GENESIS_FILE=/path/to/genesis/file PORT=9000 REGISTER_NEW_DIDS=true python3 -m server.server
```
The Ledger Browser is now available at localhost:9000
## Starting the Aries Agents
Run in two separate terminal windows:
```
aca-py start -it http 0.0.0.0 9010 -it ws 0.0.0.0 9011 -ot ws -ot http --log-config ~/Desktop/Desktop/log_set.ini --admin 0.0.0.0 5050 --admin-insecure-mode --pool-name indy_pool --log-level debug --genesis-url http://localhost:9000/genesis --auto-accept-invites --auto-accept-requests --public-invites --auto-ping-connection --auto-respond-messages --auto-respond-credential-offer --auto-respond-presentation-request --auto-verify-presentation --label aca1 -e http://0.0.0.0:9010 --wallet-name w_aca1_cli --wallet-key w_aca1_cli --wallet-type indy
```
```
aca-py start -it http 0.0.0.0 9020 -it ws 0.0.0.0 9021 -ot ws -ot http --log-config ~/Desktop/Desktop/log_set.ini --admin 0.0.0.0 5051 --admin-insecure-mode --pool-name local-pool --log-level debug --genesis-url http://localhost:9000/genesis --auto-accept-invites --auto-accept-requests --public-invites --auto-ping-connection --auto-respond-messages --auto-respond-credential-offer --auto-respond-presentation-request --auto-verify-presentation --label aca2 -e http://0.0.0.0:9020 --wallet-name w_aca2_cli --wallet-key w_aca2_cli --wallet-type indy
```
From the admin interfaces of each agent different types of requests can be generated. The interface for agent 1 is available at localhost:5050 and for agent 2 at localhost:5051.
## Connecting the two agents
No public DIDs are required for a connection.
In the interface for Agent1, issue a /connections/create-invitation request. From it's response, copy the invitation object which should look like this:
```
{
    "@type": "did:sov:BzCbsNYhMrjHiqZDTUASHg;spec/connections/1.0/invitation",
    "@id": "acedeb22-9c4e-44f5-af36-1d9359e0f247",
    "recipientKeys": [
      "EPDG8EYcQperKNEnpZy8NH237B19iDvcUXaRaeJWNeUp"
    ],
    "label": "aca1",
    "serviceEndpoint": "http://0.0.0.0:9010"
}
```
In the interface for Agent2, issue a /connections/receive-invitation request with the generated invitation object as the body.\
The response should look like this:
```
{
  "accept": "auto",
  "state": "request",
  "updated_at": "2019-08-08 16:03:39.709687Z",
  "initiator": "external",
  "created_at": "2019-08-08 16:03:39.500010Z",
  "invitation_key": "EPDG8EYcQperKNEnpZy8NH237B19iDvcUXaRaeJWNeUp",
  "their_label": "aca1",
  "request_id": "4f820e61-ea64-4d1e-90d7-6bf0d71dfaad",
  "routing_state": "none",
  "connection_id": "c4513b1f-0f6a-41d4-9695-8e035ac42c85",
  "my_did": "MnCBzULyJr7NLEmbW9PnUE"
}
```
## Registering a public DID
Next, Agent1 has to register a schema and a credential definition on the ledger. To do this, a public DID is needed.\
On Agent1, issue a /wallet/did/create request.
The response should look like this:
```
{
  "result": {
    "did": "UDyb3ptnV9wwi95no6MHvU",
    "verkey": "FqbXu3VbvL9GNgvWuRmkcgiFv3bgUtnZ55hCgDRGmANR",
    "public": "false"
  }
}
```
Now navigate to the Ledger Browser at localhost:9000 and using the did and verkey, register the DID on the ledger.\
Then, from Agent1 issue a POST /wallet/did/public request.
To test that the DID is regitered use the GET /wallet/did/public which should return the following:
```
{
  "result": {
    "did": "UDyb3ptnV9wwi95no6MHvU",
    "verkey": "FqbXu3VbvL9GNgvWuRmkcgiFv3bgUtnZ55hCgDRGmANR",
    "public": "true"
  }
}
```
## Creating a Credential Schema
On Agent1, use the POST /schemas request to send a schema to the ledger. As the body, use the following:
```
{
  "schema_version": "0.0.1",
  "attributes": [
    "name",
    "age"
  ],
  "schema_name": "person schema"
}
```
The response should look like this:
```
{
  "schema_id": "UDyb3ptnV9wwi95no6MHvU:2:person schema:0.0.1"
}
```
## Creating a Credential Definition
On Agent1, use POST /credential-definitions to send a credential definition to the ledger. As body, use the response from POST /schemas. The response should look like this:
```
{
  "credential_definition_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default"
}
```
## Issuing a Credential
On Agent1, use the POST /credential_exchange/send request. In the body, complete the credential_definition_id and the connection_id with the values generated previously (on Agent1) and the credential_values as in the following:
```
{
  "credential_values": {"name": "Alice Smith", "age": "24"},
  "credential_definition_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default",
  "connection_id": "fb377829-1b7a-4c83-85b6-8a3dbf6e2051"
}
```
On Agent2, use GET /credential_exchange to check if the exchange request was received. The output should look like this:
```
{
  "results": [
    {
      "credential_definition_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default",
      "initiator": "external",
      "created_at": "2019-08-08 16:51:26.932512Z",
      "connection_id": "c4513b1f-0f6a-41d4-9695-8e035ac42c85",
      "raw_credential": {
        "schema_id": "UDyb3ptnV9wwi95no6MHvU:2:person schema:0.0.1",
        "cred_def_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default",
        "rev_reg_id": null,
        "values": {
          "age": {
            "raw": "24",
            "encoded": "24"
          },
          "name": {
            "raw": "Alice Smith",
            "encoded": "62816810226936654797779705000772968058283780124309077049681734835796332704413"
          }
        },
        "signature": {
          "p_credential": {
            "m_2": "70227615207778282915390946358221310153086046867331598224929692702647508060776",
            "a": "85679013927393718435818365905726118518072784893531950304675239400484443346251462829835443730576077280360323233581642454369962852405161378825909562503194221144535837155100955120870530508571763146064925030930357211149486147371417232918573663441697431272650998916197100854600866071448514530613141871894540384817619557658632118124412119680459413413032710841800657492673839490166508370496681104588607887255275477121031826606296672200903277879574988253503897163537650384342758852401431469857010341772046790345514492388776276930286899622951002589168303478328021215931159389235460488546911325978836139635521266849166625316940",
            "e": "259344723055062059907025491480697571938277889515152306249728583105665800713306759149981690559193987143012367913206299323899696942213235956742929824000627020999348110416456088236253",
            "v": "7048848370171115788807749901277626009121387798757000296306566303055563129212226366347607035656521929083199549078888344352882310788255998278117529536211133711356935031658935728738638246358371080798951004953829111265651134602884461064011305358148618712404204213109483942229520116718795836964413414276944729592870810218485995706945883396320933131976698405561309366762344717729015524253205734673340189119612416250482617478936943936705736093756866853465016634579907563541108136606449766854540879198206350708935130306277591896950547779121450556504906848111959768940140803407737953881938539754360823538890037851681351526701822142787141733519436496987244771472904516322003529662098954666635967238319260308738406208202145861454507626740356698591958393654582850401260060857437212286180432417901147550812889962012912840345230979338"
          },
          "r_credential": null
        },
        "signature_correctness_proof": {
          "se": "12408944345424568758592716385474863353671516966328870945972264492354811075760295460974172030020226136840042714479272662878313289019068215152645988895535502886882125739255535609849034013770637017083921011530845253758644876185656333557111011685166369834737991721080164532967180022087363629624814298002574977277516106855657483074776858441982148718123769141248118081254500869903417681550017744056604025712612473210967370308073899823053988205317567318349858942629528066687317007780416873780270225682600388402141684838786083791564225156471392923113459280727364695470614247212989781040522729175760108451489596712886871920396",
          "c": "66393587881277659574021866596429793467828478454558582919616799530716105267953"
        },
        "rev_reg": null,
        "witness": null
      },
      "updated_at": "2019-08-08 16:51:27.598412Z",
      "schema_id": "UDyb3ptnV9wwi95no6MHvU:2:person schema:0.0.1",
      "credential_request_metadata": {
        "master_secret_blinding_data": {
          "v_prime": "3787991098844397155250682447618993239096606270747594813407647894642985403704533844206971043441133340617678515373290274239173953161806309661300899576768208614580299825197350978787058592904236774241401327406663855792696653860007018960178564177833306308080838797534027090714628074675440708251994864954082722979910019874198883759052045117441183943486024299004281367407434562551388635790663530148103704825845385754517812678228530979148108148222895527320364417285614366409548186640307305971758464547944653789272311652738025540014138638791322118017878451506322271713261968822498632217449490915639695320646592758844266082086423910543706509553680740",
          "vr_prime": null
        },
        "nonce": "310616660542479610758957",
        "master_secret_name": "w_aca2_cli"
      },
      "auto_issue": false,
      "state": "credential_received",
      "credential_exchange_id": "fe6cd5a1-72bc-4599-8252-cf9249c66203",
      "thread_id": "bfdb30de-f9e8-4cb2-b162-94b1501732c8",
      "credential_request": {
        "prover_did": "MnCBzULyJr7NLEmbW9PnUE",
        "cred_def_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default",
        "blinded_ms": {
          "u": "10791035157968612654968242884010484581056834698096893527963360594504071863041506402069922924734617425714758629999225817210500916488964258882875493500003408156927206331256179322850305263970113397881988663046847594708517936023092639830651120987713943985656238812466755477786183290103606150790346577312739301495498667217736514123361297733838464172024622447828664961711512387871292191401062617719073347024103705023858748526508126996028972802657285810660506760046771386968240019669125388735432506917262684522495667050318914861654102517896923536724949188320360492056989061295678990829767352669925484238533012328816233942772",
          "ur": null,
          "hidden_attributes": [
            "master_secret"
          ],
          "committed_attributes": {}
        },
        "blinded_ms_correctness_proof": {
          "c": "17289881482489322214031352601497333769969070400487815479055133871484934824485",
          "v_dash_cap": "65493917155744122165239850151850147695311151304562722518745229159453598038250837074132542080880065559537789923570782817315636215551708014586868235015982659949238406973090255936726626908309195515580984091569018895719139827629077688903727367166925088100899857581845651387775941406640561878770024500938324418899601762787142756307573449798094727244821336832260375233167204346471079991788274049337015536378085197253987945646666247223081673976444081763080036456253723212310864899264814278643411983037974130691349630507517704806424733687994074120562383994663868556516763666586725955935168245638163028353416275850713375458900237095401305370092399297009245592751135568602579086970521573856524347723304388861903094111053632401",
          "m_caps": {
            "master_secret": "14871527047310746298500259197357266811938124825654883641154234420145825888669646257774440520508756424466614890915833756365598583740598021811206774786575471029366991449717846803307"
          },
          "r_caps": {}
        },
        "nonce": "310616660542479610758957"
      },
      "credential_offer": {
        "schema_id": "UDyb3ptnV9wwi95no6MHvU:2:person schema:0.0.1",
        "cred_def_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default",
        "key_correctness_proof": {
          "c": "5633244417270010081345610806094166299939390978982933673588774313945343602132",
          "xz_cap": "16707885381309482944544874586146235979669547483845584032549519044853752063550700898900379553244760521623187063186472251984666858865432636269208349118145151404137776137670175367340399679772867027055646528433240850386517786884497938933339182965732716152759587404299198734805019272537016918391351894566128309090145539336112689553605264867485763602565630708772284958265164497285013317826416107586880443287477714727102128806170807958099123266363299806101307840500984097709415495233231124577970425416742314946536593274654677576261685216888059200637812757180891897360020044920391052614858769292218658775977512682071796963944268432752380151652955324135701582400576591039772868480162585336423937119849",
          "xr_cap": [
            [
              "name",
              "53299455418379044509619153273198729379505304496867260195060222634784002989346869246976915909820246105029981770854102416732654918031793879374046499656124872138285005606223328994750537446768077172668446865992412557088358951505919417828099204698833771464559738541211693257835432469484254641469911902583654062063197175694157870712190053028837141614565897392762433610322320954527771632528095732788300479826387221448666163324276092977290084592279493100359585285445451468304395118195128352730791353611981931766218329785138932579425362555762655150042062586380892842202898789022058741121786229161565364669698115669197768435716282216052652297187544716962107381796814287820284977782439923783093467632"
            ],
            [
              "age",
              "51462970069055647402369158205194604671702599898505730960751864779951787428331129742756166922760066253015153824921820932137055938112277860398208011704689323338536754071702809516226016424727515178514836160722230292504655786898566436913483077267094619430280886184295772646038595260275478978449006641135451296301343990787364979547473983956856516494359755988205126582308331909307876802005812608259279359522252756118252962504803179156951692022156494515835846503627122058605311828030215294188840986253666513079822108875441956158147138050612103486858389466207169264249505542882635195022147509458212886962338094953652942235332889001353162418615258704179642268063916879455642461209230785277716713361019"
            ],
            [
              "master_secret",
              "84217083233442101215808448360312804297419576696517668526716154800964931889823166799300276473752307743886965252182189309909604147527121358569713979180651797409147470224661841274425125430827904365766731515865099569183085735014226158753749039529625802387006868581911623796467147065705468726107840519051859902573282202738795659939388033080393746722942924473386922077424375496596596802000430274905219154711676012315511694424347888844193452138200850932720478247966446109728670624946449434765116450285584142751622207222640209887440397837870398413881739560365930643802817685816330177837735734636072470275771513832323263434427712957602483746833562807565438362192120097859182316296111215518044261710110"
            ]
          ]
        },
        "nonce": "784708612038083523810847"
      }
    }
  ]
}
```
## Save the credential
Agent2 must save the credential in its wallet. Use POST /credential_exchange/{id}/store, with the credential exchange id as the id. The response should look like the following. The state is now 'stored'.
```
{
  "credential_definition_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default",
  "initiator": "external",
  "created_at": "2019-08-08 16:51:26.932512Z",
  "connection_id": "c4513b1f-0f6a-41d4-9695-8e035ac42c85",
  "raw_credential": {
    "schema_id": "UDyb3ptnV9wwi95no6MHvU:2:person schema:0.0.1",
    "cred_def_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default",
    "rev_reg_id": null,
    "values": {
      "age": {
        "raw": "24",
        "encoded": "24"
      },
      "name": {
        "raw": "Alice Smith",
        "encoded": "62816810226936654797779705000772968058283780124309077049681734835796332704413"
      }
    },
    "signature": {
      "p_credential": {
        "m_2": "70227615207778282915390946358221310153086046867331598224929692702647508060776",
        "a": "85679013927393718435818365905726118518072784893531950304675239400484443346251462829835443730576077280360323233581642454369962852405161378825909562503194221144535837155100955120870530508571763146064925030930357211149486147371417232918573663441697431272650998916197100854600866071448514530613141871894540384817619557658632118124412119680459413413032710841800657492673839490166508370496681104588607887255275477121031826606296672200903277879574988253503897163537650384342758852401431469857010341772046790345514492388776276930286899622951002589168303478328021215931159389235460488546911325978836139635521266849166625316940",
        "e": "259344723055062059907025491480697571938277889515152306249728583105665800713306759149981690559193987143012367913206299323899696942213235956742929824000627020999348110416456088236253",
        "v": "7048848370171115788807749901277626009121387798757000296306566303055563129212226366347607035656521929083199549078888344352882310788255998278117529536211133711356935031658935728738638246358371080798951004953829111265651134602884461064011305358148618712404204213109483942229520116718795836964413414276944729592870810218485995706945883396320933131976698405561309366762344717729015524253205734673340189119612416250482617478936943936705736093756866853465016634579907563541108136606449766854540879198206350708935130306277591896950547779121450556504906848111959768940140803407737953881938539754360823538890037851681351526701822142787141733519436496987244771472904516322003529662098954666635967238319260308738406208202145861454507626740356698591958393654582850401260060857437212286180432417901147550812889962012912840345230979338"
      },
      "r_credential": null
    },
    "signature_correctness_proof": {
      "se": "12408944345424568758592716385474863353671516966328870945972264492354811075760295460974172030020226136840042714479272662878313289019068215152645988895535502886882125739255535609849034013770637017083921011530845253758644876185656333557111011685166369834737991721080164532967180022087363629624814298002574977277516106855657483074776858441982148718123769141248118081254500869903417681550017744056604025712612473210967370308073899823053988205317567318349858942629528066687317007780416873780270225682600388402141684838786083791564225156471392923113459280727364695470614247212989781040522729175760108451489596712886871920396",
      "c": "66393587881277659574021866596429793467828478454558582919616799530716105267953"
    },
    "rev_reg": null,
    "witness": null
  },
  "updated_at": "2019-08-08 16:58:38.265409Z",
  "schema_id": "UDyb3ptnV9wwi95no6MHvU:2:person schema:0.0.1",
  "credential_request_metadata": {
    "master_secret_blinding_data": {
      "v_prime": "3787991098844397155250682447618993239096606270747594813407647894642985403704533844206971043441133340617678515373290274239173953161806309661300899576768208614580299825197350978787058592904236774241401327406663855792696653860007018960178564177833306308080838797534027090714628074675440708251994864954082722979910019874198883759052045117441183943486024299004281367407434562551388635790663530148103704825845385754517812678228530979148108148222895527320364417285614366409548186640307305971758464547944653789272311652738025540014138638791322118017878451506322271713261968822498632217449490915639695320646592758844266082086423910543706509553680740",
      "vr_prime": null
    },
    "nonce": "310616660542479610758957",
    "master_secret_name": "w_aca2_cli"
  },
  "credential": {
    "referent": "00493d10-0e6b-4266-b8d5-a42b54dfdf0e",
    "attrs": {
      "name": "Alice Smith",
      "age": "24"
    },
    "schema_id": "UDyb3ptnV9wwi95no6MHvU:2:person schema:0.0.1",
    "cred_def_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default",
    "rev_reg_id": null,
    "cred_rev_id": null
  },
  "auto_issue": false,
  "state": "stored",
  "credential_exchange_id": "fe6cd5a1-72bc-4599-8252-cf9249c66203",
  "thread_id": "bfdb30de-f9e8-4cb2-b162-94b1501732c8",
  "credential_request": {
    "prover_did": "MnCBzULyJr7NLEmbW9PnUE",
    "cred_def_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default",
    "blinded_ms": {
      "u": "10791035157968612654968242884010484581056834698096893527963360594504071863041506402069922924734617425714758629999225817210500916488964258882875493500003408156927206331256179322850305263970113397881988663046847594708517936023092639830651120987713943985656238812466755477786183290103606150790346577312739301495498667217736514123361297733838464172024622447828664961711512387871292191401062617719073347024103705023858748526508126996028972802657285810660506760046771386968240019669125388735432506917262684522495667050318914861654102517896923536724949188320360492056989061295678990829767352669925484238533012328816233942772",
      "ur": null,
      "hidden_attributes": [
        "master_secret"
      ],
      "committed_attributes": {}
    },
    "blinded_ms_correctness_proof": {
      "c": "17289881482489322214031352601497333769969070400487815479055133871484934824485",
      "v_dash_cap": "65493917155744122165239850151850147695311151304562722518745229159453598038250837074132542080880065559537789923570782817315636215551708014586868235015982659949238406973090255936726626908309195515580984091569018895719139827629077688903727367166925088100899857581845651387775941406640561878770024500938324418899601762787142756307573449798094727244821336832260375233167204346471079991788274049337015536378085197253987945646666247223081673976444081763080036456253723212310864899264814278643411983037974130691349630507517704806424733687994074120562383994663868556516763666586725955935168245638163028353416275850713375458900237095401305370092399297009245592751135568602579086970521573856524347723304388861903094111053632401",
      "m_caps": {
        "master_secret": "14871527047310746298500259197357266811938124825654883641154234420145825888669646257774440520508756424466614890915833756365598583740598021811206774786575471029366991449717846803307"
      },
      "r_caps": {}
    },
    "nonce": "310616660542479610758957"
  },
  "credential_offer": {
    "schema_id": "UDyb3ptnV9wwi95no6MHvU:2:person schema:0.0.1",
    "cred_def_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default",
    "key_correctness_proof": {
      "c": "5633244417270010081345610806094166299939390978982933673588774313945343602132",
      "xz_cap": "16707885381309482944544874586146235979669547483845584032549519044853752063550700898900379553244760521623187063186472251984666858865432636269208349118145151404137776137670175367340399679772867027055646528433240850386517786884497938933339182965732716152759587404299198734805019272537016918391351894566128309090145539336112689553605264867485763602565630708772284958265164497285013317826416107586880443287477714727102128806170807958099123266363299806101307840500984097709415495233231124577970425416742314946536593274654677576261685216888059200637812757180891897360020044920391052614858769292218658775977512682071796963944268432752380151652955324135701582400576591039772868480162585336423937119849",
      "xr_cap": [
        [
          "name",
          "53299455418379044509619153273198729379505304496867260195060222634784002989346869246976915909820246105029981770854102416732654918031793879374046499656124872138285005606223328994750537446768077172668446865992412557088358951505919417828099204698833771464559738541211693257835432469484254641469911902583654062063197175694157870712190053028837141614565897392762433610322320954527771632528095732788300479826387221448666163324276092977290084592279493100359585285445451468304395118195128352730791353611981931766218329785138932579425362555762655150042062586380892842202898789022058741121786229161565364669698115669197768435716282216052652297187544716962107381796814287820284977782439923783093467632"
        ],
        [
          "age",
          "51462970069055647402369158205194604671702599898505730960751864779951787428331129742756166922760066253015153824921820932137055938112277860398208011704689323338536754071702809516226016424727515178514836160722230292504655786898566436913483077267094619430280886184295772646038595260275478978449006641135451296301343990787364979547473983956856516494359755988205126582308331909307876802005812608259279359522252756118252962504803179156951692022156494515835846503627122058605311828030215294188840986253666513079822108875441956158147138050612103486858389466207169264249505542882635195022147509458212886962338094953652942235332889001353162418615258704179642268063916879455642461209230785277716713361019"
        ],
        [
          "master_secret",
          "84217083233442101215808448360312804297419576696517668526716154800964931889823166799300276473752307743886965252182189309909604147527121358569713979180651797409147470224661841274425125430827904365766731515865099569183085735014226158753749039529625802387006868581911623796467147065705468726107840519051859902573282202738795659939388033080393746722942924473386922077424375496596596802000430274905219154711676012315511694424347888844193452138200850932720478247966446109728670624946449434765116450285584142751622207222640209887440397837870398413881739560365930643802817685816330177837735734636072470275771513832323263434427712957602483746833562807565438362192120097859182316296111215518044261710110"
        ]
      ]
    },
    "nonce": "784708612038083523810847"
  },
  "credential_id": "00493d10-0e6b-4266-b8d5-a42b54dfdf0e"
}
```

## Issue and receive a proof request
On Agent1, use POST /presentation_exchange/send_request to request a proof. Use the following model, and replace cred_def_id and connection_id with your values.
```
{
  "requested_predicates": [
    {
      "name": "age",
      "p_type": ">=",
      "restrictions": [
        {"cred_def_id" : "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default"}
      ],
      "p_value":  18
    }
  ],
  "requested_attributes": [
    {
      "name": "name",
      "restrictions": [
        {"cred_def_id" : "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default"}
      ]
    }
  ],
  "name": "Proof of Age",
  "version": "1.0",
  "connection_id": "fb377829-1b7a-4c83-85b6-8a3dbf6e2051"
}
```
The response will look like the following:
```
{
  "connection_id": "fb377829-1b7a-4c83-85b6-8a3dbf6e2051",
  "updated_at": "2019-08-08 17:09:05.830181Z",
  "state": "request_sent",
  "presentation_request": {
    "name": "Proof of Age",
    "version": "1.0",
    "nonce": "111301346160293691683693576433563183068",
    "requested_attributes": {
      "35845eaa-2f2b-4369-a34a-5e4afd296dc5": {
        "name": "name",
        "restrictions": [
          {
            "cred_def_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default"
          }
        ]
      }
    },
    "requested_predicates": {
      "85c96f5e-7f0b-4286-8ab1-1ca8931027fe": {
        "name": "age",
        "p_type": ">=",
        "restrictions": [
          {
            "cred_def_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default"
          }
        ],
        "p_value": 18
      }
    }
  },
  "initiator": "self",
  "thread_id": "6cacefe5-f5bd-4dcf-aa01-97425425310c",
  "presentation_exchange_id": "ad4e80ec-e6bd-49cc-b6df-9d476fa76057",
  "created_at": "2019-08-08 17:09:05.830181Z"
}
```
Agent2 will automatically respond. To view the received proof, use on Agent1 GET /presentation_exchange/{id} using the presentation_exchange_id generated before. The response will look like the following:
```
{
  "connection_id": "fb377829-1b7a-4c83-85b6-8a3dbf6e2051",
  "presentation": {
    "proof": {
      "proofs": [
        {
          "primary_proof": {
            "eq_proof": {
              "revealed_attrs": {
                "name": "62816810226936654797779705000772968058283780124309077049681734835796332704413"
              },
              "a_prime": "29044364586137304849337360559057108242252088989671121451195421465705376211266121943809171417887277440837719859470641548848928883982741757504586035486760151214637244954572931206205383280825722133043129545378092824483223527458228108786866998749815749323046500707015589100614318328851758363932242566609824316397191370405851492472675609723928237507982260128122515656115718112108979517880571348763654438232616648108778061659515932958209345109637969554811956466893533387477856881981380235085509569970342533259342541394275423202214325904560906351974679064544382372525896360327543688167340112500908023405657390736840857733794",
              "e": "94224397255772556331809060473529831226314775449564920674147248771104640042782354956265372799049365269919943362696234307445416586398370296",
              "v": "1211331929341848614070987318164957195271160721103822320888182447039064512106069567806806650586445041231344189969527829492689159841644279961326414541914852861554924428048247352535282708814978252507526330613268564636812286748087168637965470582485915114792114516153268248117100502273544008178314871442725553979879106485680894176206406541649090173916040108687713287171111037386446501498869248791453985985449471283235932945651667478850259218305007276216861906961606440530870371861153063547333325243478100980627912080570209446449899205952328143153614720551448238313888147851339654649615571454158233735297561352306328172806954949283928130542722342768513788112516714578888151540404079105597467823207583160988221716777139963466048004096554418142957636451741497434350467756390474963604229958903165666015341562495243169388380286756910102506114342317313974473766171572109407556863397990784437216871513239882880685996069936722775363277",
              "m": {
                "age": "7897403415849420192180805844450330442928067106390821482554939183466654888113213632326763337243865291702713779497843323794705717823450095487401091349294863675101462100762535019871",
                "master_secret": "96401477897438878977236278944095917486716005735963756071828301511033232571738743052766983979786624405213521224892312177498007345518177762393430780323081957680198950446008363321"
              },
              "m2": "8293121577383083329787620423292247511382599718210068738414924044049261751688363492312392667681654607229088782890358310772398592778518920879102791393697989493361410406301311018847"
            },
            "ge_proofs": [
              {
                "u": {
                  "0": "377659007154055105793191614873767042718110411075768650374527722328419800220614313495903717684117091429501042593393658585198078992132651071612119081208666315129609630860941657533",
                  "1": "15102189208386250142335476405755339995402090060927889238125509102361267378165769660244284280703814899916242755803342724999702597398342341679373651353709414633107589240996416857088",
                  "2": "16030379206420358843044189790869223701488123064306262175104749276942626886624900746328058640459331059344432800417503114918455617522462591083201158117862731643554949260546036536820",
                  "3": "16101956026036436147405423256187925676256039359738703241992816110567328957036815169914910161413843866593173779534491905808448785318832501620021455919413783127110096140019344067943"
                },
                "r": {
                  "0": "577935997294184453465162218332771704850287539003703609619325308700614660659816160999587084892203799953357792931460324801810248243439389535070204109367744763683542822362007841212401676927148045141197897733081116768733791045930314108433940146195214771739523412431091973767650093435098068742820504683379961755600267156851504747442900607621089017349452038736949629148478499171343267747934814012006344352310008560882906812759371275048339603162264416880641844400205346978391451071939709129871964494702823020961414057497106858361674038601858870617744921522891626636850890474076105666467060999101478314877490559780285546734828748974201749110085299408501595472952472492376467000507654304973179817826317237912469009473753485279",
                  "1": "667424618260062431172069638253737803643250360435623880515901802402415238325686366432050439809420284611946865522491127842954703736464158505280254451111124532061428891807606801898491371544818803532511175740215550529968292183506285120631980123589395519031983040840384999507344614706568252825918059305192805103830366712604949671246306548532827131314190362630032774109222052087440528930700176664470376562633755011423924873882231282955953298596921690239731976108739131740699962616878081796450694731504123248079877479025403416898414728520810591535005442783902471717750072667862759336941059311631343747794867963410792076119450678880176169032284916422085790832888654706303411484703867398766729233103908420871995194337810803447",
                  "2": "1527616296878982640069975423253824335571948684531702124335747533035581891293981589302730775866177574654391374770179566926622416459641181239652140358234293103002460321999895836301656189906193932602048595139544663519375519615033161050268868976445330925538657064898548029091598466799082889703967590338139142243454861567052119752665476971105526943976894085414904488057068697952313895776486362340545030367358074234530161730865548719782369226992506683649758972681106420830115409576046100579813733217981230024952518005981406412679227013687137844518875212779002360379355916340272557738094499318173935935260965316211844671070477051492864317023847077589085657720461558380490261305804833763783856360669840035612951496352337433390",
                  "3": "1206394914896862540113426895553911751529493925212186194069654088043190646377161427674613411147541607211264217496974085245217565966506381612253401312954311892244164340490391228596921067641488610966068350949938133482923616563880568297793664304334913373761058405144382945068850572615523619394987818503354130515819743454774552624544084035010174340718517606946728976198341272840044113804098806053308602125862081065155289918043245938145064571306566385569157314713278710826072840628376276434513984858908466711936512047832235251997479843842560544030989604249377478509792950919932193709209801122050388423652505274964016021531200492901055729089386786941303890890034554202030875908334903949563832943717609775283563574543369073380",
                  "DELTA": "1450886730172366795679141475117086400368457208527298355699218465785957632033296630902761573512121723699211941653272776770850924830309739229225154618237513659235494903517600774517086940965043502967732490737414749637471104637834917079853591543172723807524519073305509170573889452323864318413018469105202063659844874901889914300733622524600082123805373198808541107168094854060586456988882471113165094861019172519985252346112751825930344410637440480530682583228402393173735098551689600781833163811231759843423721533767040094639650477950528259594857385673251488436422768866437549342763100258381313845137487846197895429890309917704167664397209609447615723791745906848719924430903310226119551809485585121314244940823891026673"
                },
                "mj": "7897403415849420192180805844450330442928067106390821482554939183466654888113213632326763337243865291702713779497843323794705717823450095487401091349294863675101462100762535019871",
                "alpha": "30079254557479471198173045180763134573070261345784703062831531155749058686633414792658175918285203413648797431190588671247518798881349825116098661532324446509835597568469935129277326653603529630768669249993471206112431012667859545631337374433705517295851677891469598241390350824305859078131677033904404365348296227314473612570900321635698627785296445789018981463305347655067310537304109377268558414054747832099804365150913076823949722478013273756990848867299554487811446978916960500611353023902636831998827476896519583836627946800421108853059149935900066309902098471449484897758720169524685746869230232972482651843499811969678666338685810442260648538820428385305366832842598418284510660649235945272204067360884094396030579166764962170476539589234524430315847528395940425329004954247858707426446758678645052035568761066984770248154718573153",
                "t": {
                  "0": "24305608152263005383435404540148563122554847112246620951980664975423686806820579356725450399249292499239248044607065702239764995894693965648823004519769930169786851503987133077686324457458661902989458530855576604039720814205966465459141834560638912894825216674423476333816411262015225791812492276580993181083163328828402028935506636335185142070273406755314074593416526319494775679689451167784899687309750640830902863392214322884813192579403283141869792861256009862160550738750025617162000591455866313995804961495416790460694865891712187496213042621263011776785741358411556099473730027040292388783453694644828961293388",
                  "1": "64587712559660866108928523428028508800982628306974060405951133340064576519645569338027678851091360460609621115541527766258201856747416278202769349897109174894447525415653561338811990868027453274628750886517179869459403495443176801470799183505221201100702158508225137621863853681340421006471948911120353598192321080660617192456924230923898091247254252067917636278306504900702038601033160345490536752092901841677794380379000347692955143876672439984577018749523694899208215741145202048887018352624073274042155047276093924282974151049873322706580005580915417488138202679113899168415359471638796463510663459202313400574321",
                  "2": "466525908116207698266897825443421409803932456262871516895523156279068626646039706005774688795621359294419749145450103779981656332310415801241513691416511313291908386407121030291900195743487357675778740688343894449545077660157533540318204350071896883212293850270775762591320674342181767776517376320873401901454611036569129241200664944037857391405012359694846243483675102420067748495568334208933335642342758410076586294772525522447886535151026440630117308216008272308674487318145620417625047514317848583805583580399294882775723773478648961743425193063768209630384917835973133564905526760574315643979504692361931350908",
                  "3": "73639355118286582576749185245560178661919464778710806504138713038665169493052710888287175047737810224714084869074767686874179676336089060082546319965564403535757825615596100057653183491271335936917853727731558751982581601028742536066899383664357610524635888334682575349326958491665068706554663003151888052365061978271205356373599824220858292923262323786326732284309598548846702468979818931215494262860062165019806317726762363293270537090820555000250389675571630274977205748218655102536846875732963471954877091896228861056549006205653211272561585440797442255616889937890818274666799963643300135305709950401644774472613",
                  "DELTA": "17467511704752459858939061217456590221614069422470087501409440878166154976198444221202379067029555901029594455108925825998940745066722307424176046036561293885076414976600608225882479971083164086307163389735991306844158927057154451132138754687141761009384725652379147285005479564134138152141214127721282301862024707708022735601347898452662955757548916317486499909562768402129465971639920505651590910171680312278920730832427262496706547225954066774333386205342926524091867791643174639284596818397372443988755136928023970913444412788161060097771202883927396120951610903603263099587479090383610589524519263921205402616140"
                },
                "predicate": {
                  "attr_name": "age",
                  "p_type": "GE",
                  "value": 18
                }
              }
            ]
          },
          "non_revoc_proof": null
        }
      ],
      "aggregated_proof": {
        "c_hash": "71879259135773616223263644488462503278210100016220566194897097398588485460215",
        "c_list": [
          [
            230,
            19,
           ...
            65,
            76
          ]
        ]
      }
    },
    "requested_proof": {
      "revealed_attrs": {
        "35845eaa-2f2b-4369-a34a-5e4afd296dc5": {
          "sub_proof_index": 0,
          "raw": "Alice Smith",
          "encoded": "62816810226936654797779705000772968058283780124309077049681734835796332704413"
        }
      },
      "self_attested_attrs": {},
      "unrevealed_attrs": {},
      "predicates": {
        "85c96f5e-7f0b-4286-8ab1-1ca8931027fe": {
          "sub_proof_index": 0
        }
      }
    },
    "identifiers": [
      {
        "schema_id": "UDyb3ptnV9wwi95no6MHvU:2:person schema:0.0.1",
        "cred_def_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default",
        "rev_reg_id": null,
        "timestamp": null
      }
    ]
  },
  "updated_at": "2019-08-08 17:09:07.619683Z",
  "state": "verified",
  "presentation_request": {
    "name": "Proof of Age",
    "version": "1.0",
    "nonce": "111301346160293691683693576433563183068",
    "requested_attributes": {
      "35845eaa-2f2b-4369-a34a-5e4afd296dc5": {
        "name": "name",
        "restrictions": [
          {
            "cred_def_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default"
          }
        ]
      }
    },
    "requested_predicates": {
      "85c96f5e-7f0b-4286-8ab1-1ca8931027fe": {
        "name": "age",
        "p_type": ">=",
        "restrictions": [
          {
            "cred_def_id": "UDyb3ptnV9wwi95no6MHvU:3:CL:21:default"
          }
        ],
        "p_value": 18
      }
    }
  },
  "initiator": "self",
  "thread_id": "6cacefe5-f5bd-4dcf-aa01-97425425310c",
  "presentation_exchange_id": "ad4e80ec-e6bd-49cc-b6df-9d476fa76057",
  "verified": "true",
  "created_at": "2019-08-08 17:09:05.830181Z"
}
```
# Full connection protocol
Connecting 2 agents without ```--auto-accept-invites --auto-accept-requests```.\
The step 'Connecting the two agents' from above remains the same. After performing this step, the connection invitation is stored by Agent2.
## Accepting the invitation
On Agent2, use the POST /connections/{id}/accept-invitation endpoint, using the id of the stored connection invitation.\
The state of the connection will become 'request'.
```
{
  "state": "request",
  "routing_state": "none",
  "my_did": "VwCnhNdp92b94r5gtyi7nS",
  "their_label": "aca1",
  "initiator": "external",
  "connection_id": "387d8294-78fb-4622-a90d-8173190c9f9e",
  "updated_at": "2019-08-10 17:51:40.670745Z",
  "invitation_key": "ESRUvpwsxnoN3BQH76f9h7ghL8cjXMcpB7nkwGB3CbxW",
  "accept": "manual",
  "request_id": "8d12fb22-db27-4950-aeaa-f828062039ee",
  "created_at": "2019-08-10 15:19:18.031911Z"
}
```
## Accepting the request
On Agent1, the request must be accepted using POST /connections/{id}/accept-request. The response will look like the following:
```
{
  "accept": "manual",
  "my_did": "2jmGdUYkedrvru6qWo42Zh",
  "their_did": "VwCnhNdp92b94r5gtyi7nS",
  "their_label": "aca2",
  "updated_at": "2019-08-10 17:57:55.104705Z",
  "state": "response",
  "created_at": "2019-08-10 15:18:24.778365Z",
  "invitation_key": "ESRUvpwsxnoN3BQH76f9h7ghL8cjXMcpB7nkwGB3CbxW",
  "initiator": "self",
  "routing_state": "none",
  "connection_id": "be3700a7-0313-4995-9c46-72a4608b5c49"
}
```
## Checking the state of the connection
Now the connection should be active. We check the status on both agents using GET /connections/{id}.\
On Agent1:
```
{
  "accept": "manual",
  "my_did": "2jmGdUYkedrvru6qWo42Zh",
  "their_did": "VwCnhNdp92b94r5gtyi7nS",
  "their_label": "aca2",
  "updated_at": "2019-08-10 17:57:55.667862Z",
  "state": "active",
  "created_at": "2019-08-10 15:18:24.778365Z",
  "invitation_key": "ESRUvpwsxnoN3BQH76f9h7ghL8cjXMcpB7nkwGB3CbxW",
  "initiator": "self",
  "routing_state": "none",
  "connection_id": "be3700a7-0313-4995-9c46-72a4608b5c49"
}
```
On Agent2:
```
{
  "state": "active",
  "routing_state": "none",
  "my_did": "VwCnhNdp92b94r5gtyi7nS",
  "their_label": "aca1",
  "initiator": "external",
  "connection_id": "387d8294-78fb-4622-a90d-8173190c9f9e",
  "updated_at": "2019-08-10 17:57:55.833026Z",
  "invitation_key": "ESRUvpwsxnoN3BQH76f9h7ghL8cjXMcpB7nkwGB3CbxW",
  "accept": "manual",
  "request_id": "8d12fb22-db27-4950-aeaa-f828062039ee",
  "their_did": "2jmGdUYkedrvru6qWo42Zh",
  "created_at": "2019-08-10 15:19:18.031911Z"
}
```
Note: The connection ID is local for each agent.\
The connection's state is now ```active``` on both agents.
